#! /usr/bin/env bash
#
# Determine locations of the tree-sitter C library and headers.
#
# Tries to support Ubuntu for x86_64, with either musl or glibc depending
# on [the name of] the opam setup.
#
set -eu

# Generate config files in shell and make formats.
config_sh=config.sh
config_mk=config.mk

if [[ ! -e tree-sitter ]]; then
  git clone --depth 1 https://github.com/tree-sitter/tree-sitter.git
fi

# Try to detect whether we want to use glibc and dynamic linking,
# or musl and static linking.
#
use_musl=false
case "$(opam switch)" in
  *+musl+*)
    echo "Attempting configuration for musl and static linking."
    use_musl=true
    ;;
  *)
    echo "Using default configuration suitable for glibc and dynamic linking."
esac

if [[ "$use_musl" = true ]]; then
  CC=musl-gcc
else
  CC=gcc
fi
export CC

if [[ -z "${PREFIX+x}" ]]; then
  PREFIX=/usr/local
fi
export PREFIX

if [[ -z "${INCLUDEDIR+x}" ]]; then
  if [[ "$use_musl" = true ]]; then
    INCLUDEDIR="/usr/include/x86_64-linux-musl"
  else
    INCLUDEDIR="$PREFIX"/include
  fi
fi
export INCLUDEDIR

if [[ -z "${LIBDIR+x}" ]]; then
  if [[ "$use_musl" = true ]]; then
    LIBDIR="/usr/lib/x86_64-linux-musl"
  else
    LIBDIR="$PREFIX"/lib
  fi
fi
export LIBDIR

cat <<EOF
Config for libtree-sitter:
  CC: $CC
  PREFIX: $PREFIX
  INCLUDEDIR: $INCLUDEDIR
  LIBDIR: $LIBDIR
Config file for bash: $config_sh
Config file for make: $config_mk
EOF

cat > "$config_sh" <<EOF
# Config for libtree-sitter, generated by $0

# C compiler
CC="$CC"
export CC

# Default install prefix
PREFIX="$PREFIX"
export PREFIX

# Where the C headers get installed, in particular 'tree_sitter/api.h'.
INCLUDEDIR="$INCLUDEDIR"
export INCLUDEDIR

# Where the tree-sitter runtime library gets installed.
LIBDIR="$LIBDIR"
export LIBDIR
EOF

# It's a polyglot config file!
cp "$config_sh" "$config_mk"
