#TODO: json_reader.ml should be an autogenerated json_reader.re at some point
all: grammar.json ex1.json AST.ml json_reader.ml

TOP=../..

# you need 'make' from $(TOP)
GEN=$(TOP)/bin/ocaml-tree-sitter
# you need 'npm install tree-sitter-cli' from $(TOP)
CLI=$(TOP)/node_modules/.bin/tree-sitter

grammar.json: grammar.js
	$(CLI) generate
	cp -f src/grammar.json .

ex1.json: ex1.txt grammar.json
	npm init -y
	npm install
	cp $(TOP)/scripts/tree-sitter-parser.js .
	# ydump is the json pretty-printer that comes with atdgen
	./tree-sitter-parser.js ex1.txt | ydump > ex1.json

AST.ml: grammar.json
	$(GEN) $^

clean:
	rm -f *.gyp index.js
	rm -rf src/ build/
	rm -f package-lock.json package.json
	rm -f .merlin
	rm -f AST.ml Parse.ml

# take care, because dune runtest from $(TOP) will not work without those files
distclean:
	rm -f grammar.json ex1.json ast.re json_reader.re
